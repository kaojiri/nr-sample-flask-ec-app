{% extends "base.html" %}

{% block title %}åˆ†æ•£ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ãƒ‡ãƒ¢ - EC Shop{% endblock %}

{% block content %}
<div class="alert alert-info" role="alert">
    <h4 class="alert-heading">ğŸ”— åˆ†æ•£ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ãƒ‡ãƒ¢</h4>
    <p>ã“ã®ãƒšãƒ¼ã‚¸ã¯ New Relic ã®<strong>åˆ†æ•£ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°æ©Ÿèƒ½</strong>ã‚’ãƒ‡ãƒ¢ã™ã‚‹ãŸã‚ã«ã€ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰åˆ¥ã‚³ãƒ³ãƒ†ãƒŠã®åˆ†æ•£ã‚µãƒ¼ãƒ“ã‚¹ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚</p>
    <hr>
    <p class="mb-0">å„æ“ä½œã§userIdãŒCustom Attributeã¨ã—ã¦è¨­å®šã•ã‚Œã€åˆ†æ•£ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®ãƒˆãƒ¬ãƒ¼ã‚¹ãŒå¯è¦–åŒ–ã•ã‚Œã¾ã™ã€‚</p>
</div>

{% if not service_available %}
<div class="alert alert-warning" role="alert">
    <h5>âš ï¸ åˆ†æ•£ã‚µãƒ¼ãƒ“ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼</h5>
    <p>åˆ†æ•£ã‚µãƒ¼ãƒ“ã‚¹ã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚Docker Composeã§åˆ†æ•£ã‚µãƒ¼ãƒ“ã‚¹ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
    {% if error %}
    <p><strong>ã‚¨ãƒ©ãƒ¼è©³ç´°:</strong> {{ error }}</p>
    {% endif %}
</div>
{% endif %}

<h1>åˆ†æ•£ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ãƒ‡ãƒ¢</h1>
<p class="lead">ä»¥ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰åˆ†æ•£ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡Œã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚</p>

{% if current_user.is_authenticated %}
<div class="alert alert-success">
    <i class="fas fa-user"></i> ãƒ­ã‚°ã‚¤ãƒ³ä¸­: <strong>{{ current_user.username }}</strong> (ID: {{ current_user.id }})
    <br><small>ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒCustom Attributeã¨ã—ã¦New Relicã«é€ä¿¡ã•ã‚Œã¾ã™</small>
</div>
{% endif %}

<div class="row mt-4">
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5>ğŸ”„ N+1 ã‚¯ã‚¨ãƒªå•é¡Œ</h5>
            </div>
            <div class="card-body">
                <p><strong>å‹•ä½œ:</strong> åˆ†æ•£ã‚µãƒ¼ãƒ“ã‚¹ã§N+1ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œ</p>
                <p><strong>New Relic ã§ç¢ºèªã§ãã‚‹ã“ã¨:</strong></p>
                <ul>
                    <li>ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª â†’ åˆ†æ•£ã‚µãƒ¼ãƒ“ã‚¹ã®åˆ†æ•£ãƒˆãƒ¬ãƒ¼ã‚¹</li>
                    <li>userIdã®Custom Attribute</li>
                    <li>åˆ†æ•£ã‚µãƒ¼ãƒ“ã‚¹ã§ã®å¤§é‡ã‚¯ã‚¨ãƒªå®Ÿè¡Œ</li>
                    <li>HTTPé€šä¿¡ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“</li>
                </ul>
                
                <div class="mb-3">
                    <label for="nPlusOneLimit" class="form-label">å•†å“æ•°åˆ¶é™:</label>
                    <input type="number" class="form-control" id="nPlusOneLimit" value="20" min="1" max="100">
                </div>
                
                <button class="btn btn-warning" onclick="callNPlusOne()" {% if not service_available %}disabled{% endif %}>
                    <i class="fas fa-database"></i> N+1ã‚¯ã‚¨ãƒªå®Ÿè¡Œ
                </button>
                <div id="nPlusOneResult" class="mt-3"></div>
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header bg-danger text-white">
                <h5>ğŸŒ ã‚¹ãƒ­ãƒ¼ã‚¯ã‚¨ãƒª</h5>
            </div>
            <div class="card-body">
                <p><strong>å‹•ä½œ:</strong> åˆ†æ•£ã‚µãƒ¼ãƒ“ã‚¹ã§æ„å›³çš„ã«é…ã„ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œ</p>
                <p><strong>New Relic ã§ç¢ºèªã§ãã‚‹ã“ã¨:</strong></p>
                <ul>
                    <li>åˆ†æ•£ãƒˆãƒ¬ãƒ¼ã‚¹ã§ã®å‡¦ç†æ™‚é–“ã®å†…è¨³</li>
                    <li>pg_sleepã‚„Cartesian Productã®å®Ÿè¡Œ</li>
                    <li>userIdã‚’å«ã‚€ã‚¹ãƒ­ãƒ¼ã‚¯ã‚¨ãƒªã®è©³ç´°</li>
                    <li>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡Œ</li>
                </ul>
                
                <div class="mb-3">
                    <label for="sleepDuration" class="form-label">ã‚¹ãƒªãƒ¼ãƒ—æ™‚é–“ (ç§’):</label>
                    <input type="number" class="form-control" id="sleepDuration" value="3.0" min="1" max="10" step="0.5">
                </div>
                
                <div class="mb-3">
                    <label for="queryType" class="form-label">ã‚¯ã‚¨ãƒªã‚¿ã‚¤ãƒ—:</label>
                    <select class="form-control" id="queryType">
                        <option value="sleep">pg_sleep (ã‚·ãƒ³ãƒ—ãƒ«é…å»¶)</option>
                        <option value="complex_join">è¤‡é›‘ãªJOIN</option>
                        <option value="cartesian_product">Cartesian Product</option>
                    </select>
                </div>
                
                <button class="btn btn-danger" onclick="callSlowQuery()" {% if not service_available %}disabled{% endif %}>
                    <i class="fas fa-clock"></i> ã‚¹ãƒ­ãƒ¼ã‚¯ã‚¨ãƒªå®Ÿè¡Œ
                </button>
                <div id="slowQueryResult" class="mt-3"></div>
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-4">
        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <h5>ğŸ’¥ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼</h5>
            </div>
            <div class="card-body">
                <p><strong>å‹•ä½œ:</strong> åˆ†æ•£ã‚µãƒ¼ãƒ“ã‚¹ã§æ„å›³çš„ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ã‚’ç™ºç”Ÿ</p>
                <p><strong>New Relic ã§ç¢ºèªã§ãã‚‹ã“ã¨:</strong></p>
                <ul>
                    <li>åˆ†æ•£ãƒˆãƒ¬ãƒ¼ã‚¹ã§ã®ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿç®‡æ‰€</li>
                    <li>userIdã‚’å«ã‚€ã‚¨ãƒ©ãƒ¼è©³ç´°</li>
                    <li>ã‚¨ãƒ©ãƒ¼ã®ç¨®é¡ã¨åŸå› </li>
                    <li>åˆ†æ•£ã‚·ã‚¹ãƒ†ãƒ ã§ã®ã‚¨ãƒ©ãƒ¼ä¼æ’­</li>
                </ul>
                
                <div class="mb-3">
                    <label for="errorType" class="form-label">ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—:</label>
                    <select class="form-control" id="errorType">
                        <option value="syntax">SQLã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ã‚¨ãƒ©ãƒ¼</option>
                        <option value="constraint">åˆ¶ç´„é•åã‚¨ãƒ©ãƒ¼</option>
                        <option value="connection">æ¥ç¶šã‚¨ãƒ©ãƒ¼</option>
                        <option value="timeout">ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼</option>
                    </select>
                </div>
                
                <button class="btn btn-danger" onclick="callDatabaseError()" {% if not service_available %}disabled{% endif %}>
                    <i class="fas fa-exclamation-triangle"></i> ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ
                </button>
                <div id="databaseErrorResult" class="mt-3"></div>
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-4">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h5>ğŸ§ª å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</h5>
            </div>
            <div class="card-body">
                <p><strong>å‹•ä½œ:</strong> åˆ†æ•£ã‚µãƒ¼ãƒ“ã‚¹ã§å…¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã‚’é †æ¬¡å®Ÿè¡Œ</p>
                <p><strong>New Relic ã§ç¢ºèªã§ãã‚‹ã“ã¨:</strong></p>
                <ul>
                    <li>è¤‡æ•°æ“ä½œã‚’å«ã‚€é•·ã„åˆ†æ•£ãƒˆãƒ¬ãƒ¼ã‚¹</li>
                    <li>å„æ“ä½œã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒ</li>
                    <li>userIdã‚’å«ã‚€åŒ…æ‹¬çš„ãªå®Ÿè¡Œãƒ­ã‚°</li>
                    <li>åˆ†æ•£ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®å‡¦ç†ãƒ•ãƒ­ãƒ¼</li>
                </ul>
                
                <button class="btn btn-primary" onclick="callTestAll()" {% if not service_available %}disabled{% endif %}>
                    <i class="fas fa-play-circle"></i> å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
                </button>
                <div id="testAllResult" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<div class="alert alert-info mt-4">
    <h5>ğŸ“Š New Relic ã§ã®ç¢ºèªæ–¹æ³•</h5>
    <ol>
        <li><strong>Distributed Tracing</strong>: ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª â†’ åˆ†æ•£ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’ç¢ºèª</li>
        <li><strong>Custom Attributes</strong>: userIdã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¦ç‰¹å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ“ä½œã‚’è¿½è·¡</li>
        <li><strong>Service Map</strong>: ã‚µãƒ¼ãƒ“ã‚¹é–“ã®ä¾å­˜é–¢ä¿‚ã¨é€šä¿¡ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å¯è¦–åŒ–</li>
        <li><strong>APM Overview</strong>: å„ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æŒ‡æ¨™ã‚’æ¯”è¼ƒ</li>
        <li><strong>Errors Inbox</strong>: åˆ†æ•£ã‚·ã‚¹ãƒ†ãƒ ã§ã®ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿã¨ä¼æ’­ã‚’ç¢ºèª</li>
    </ol>
</div>

<div class="alert alert-warning mt-4">
    <h5>ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°</h5>
    <p>åˆ†æ•£ã‚µãƒ¼ãƒ“ã‚¹ã«æ¥ç¶šã§ããªã„å ´åˆ:</p>
    <ol>
        <li><code>docker-compose ps</code> ã§åˆ†æ•£ã‚µãƒ¼ãƒ“ã‚¹ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª</li>
        <li><code>docker-compose logs distributed-service</code> ã§ãƒ­ã‚°ã‚’ç¢ºèª</li>
        <li>ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®šã¨ãƒãƒ¼ãƒˆ5002ãŒåˆ©ç”¨å¯èƒ½ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª</li>
    </ol>
    
    <button class="btn btn-outline-info btn-sm" onclick="checkServiceHealth()">
        <i class="fas fa-heartbeat"></i> ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ç¢ºèª
    </button>
    <div id="healthCheckResult" class="mt-2"></div>
</div>

<div class="mt-4">
    <a href="{{ url_for('main.index') }}" class="btn btn-outline-primary">â† ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</a>
    <a href="{{ url_for('performance.index') }}" class="btn btn-outline-secondary">ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ‡ãƒ¢</a>
</div>

<script>
// å…±é€šã®AJAXå‘¼ã³å‡ºã—é–¢æ•°
function makeDistributedCall(endpoint, data, resultElementId) {
    const resultElement = document.getElementById(resultElementId);
    resultElement.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> å®Ÿè¡Œä¸­...</div>';
    
    const startTime = Date.now();
    
    fetch(`/distributed/${endpoint}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        // èªè¨¼ã‚¨ãƒ©ãƒ¼ï¼ˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼‰ã‚’ãƒã‚§ãƒƒã‚¯
        if (response.redirected || response.url.includes('/auth/login')) {
            throw new Error('èªè¨¼ãŒå¿…è¦ã§ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
        }
        
        // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒJSONã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰äºˆæœŸã—ãªã„ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ãŒè¿”ã•ã‚Œã¾ã—ãŸ');
        }
        
        return response.json();
    })
    .then(data => {
        const executionTime = Date.now() - startTime;
        
        if (data.success) {
            resultElement.innerHTML = `
                <div class="alert alert-success">
                    <h6><i class="fas fa-check-circle"></i> å®Ÿè¡ŒæˆåŠŸ</h6>
                    <p><strong>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</strong> ${data.message}</p>
                    <p><strong>å®Ÿè¡Œæ™‚é–“:</strong> ${executionTime}ms (ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´)</p>
                    ${data.result && data.result.data ? `
                        <details>
                            <summary>è©³ç´°çµæœ</summary>
                            <pre class="mt-2">${JSON.stringify(data.result.data, null, 2)}</pre>
                        </details>
                    ` : ''}
                </div>
            `;
        } else {
            resultElement.innerHTML = `
                <div class="alert alert-danger">
                    <h6><i class="fas fa-exclamation-circle"></i> å®Ÿè¡Œã‚¨ãƒ©ãƒ¼</h6>
                    <p><strong>ã‚¨ãƒ©ãƒ¼:</strong> ${data.error}</p>
                    <p><strong>å®Ÿè¡Œæ™‚é–“:</strong> ${executionTime}ms</p>
                    ${data.details ? `<p><strong>è©³ç´°:</strong> ${data.details}</p>` : ''}
                </div>
            `;
        }
    })
    .catch(error => {
        const executionTime = Date.now() - startTime;
        
        let errorMessage = error.message;
        let errorType = 'é€šä¿¡ã‚¨ãƒ©ãƒ¼';
        
        if (error.message.includes('èªè¨¼ãŒå¿…è¦')) {
            errorType = 'èªè¨¼ã‚¨ãƒ©ãƒ¼';
            errorMessage = 'ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚';
        } else if (error.message.includes('äºˆæœŸã—ãªã„ãƒ¬ã‚¹ãƒãƒ³ã‚¹')) {
            errorType = 'ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¨ãƒ©ãƒ¼';
            errorMessage = 'ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰HTMLãŒè¿”ã•ã‚Œã¾ã—ãŸã€‚èªè¨¼çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
        }
        
        resultElement.innerHTML = `
            <div class="alert alert-danger">
                <h6><i class="fas fa-times-circle"></i> ${errorType}</h6>
                <p><strong>ã‚¨ãƒ©ãƒ¼:</strong> ${errorMessage}</p>
                <p><strong>å®Ÿè¡Œæ™‚é–“:</strong> ${executionTime}ms</p>
                ${error.message.includes('èªè¨¼') ? `
                    <button class="btn btn-sm btn-primary mt-2" onclick="window.location.reload()">
                        <i class="fas fa-refresh"></i> ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿
                    </button>
                ` : ''}
            </div>
        `;
    });
}

// N+1ã‚¯ã‚¨ãƒªå®Ÿè¡Œ
function callNPlusOne() {
    const limit = document.getElementById('nPlusOneLimit').value;
    makeDistributedCall('n-plus-one', { limit: parseInt(limit) }, 'nPlusOneResult');
}

// ã‚¹ãƒ­ãƒ¼ã‚¯ã‚¨ãƒªå®Ÿè¡Œ
function callSlowQuery() {
    const sleepDuration = document.getElementById('sleepDuration').value;
    const queryType = document.getElementById('queryType').value;
    makeDistributedCall('slow-query', { 
        sleep_duration: parseFloat(sleepDuration),
        query_type: queryType
    }, 'slowQueryResult');
}

// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼å®Ÿè¡Œ
function callDatabaseError() {
    const errorType = document.getElementById('errorType').value;
    makeDistributedCall('database-error', { error_type: errorType }, 'databaseErrorResult');
}

// å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
function callTestAll() {
    makeDistributedCall('test-all', {}, 'testAllResult');
}

// ã‚µãƒ¼ãƒ“ã‚¹ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
function checkServiceHealth() {
    const resultElement = document.getElementById('healthCheckResult');
    resultElement.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> ç¢ºèªä¸­...</div>';
    
    fetch('/distributed/health')
    .then(response => response.json())
    .then(data => {
        if (data.distributed_service_available) {
            resultElement.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> åˆ†æ•£ã‚µãƒ¼ãƒ“ã‚¹ã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™
                </div>
            `;
        } else {
            resultElement.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-times-circle"></i> åˆ†æ•£ã‚µãƒ¼ãƒ“ã‚¹ã«æ¥ç¶šã§ãã¾ã›ã‚“
                    ${data.error ? `<br><strong>ã‚¨ãƒ©ãƒ¼:</strong> ${data.error}` : ''}
                </div>
            `;
        }
    })
    .catch(error => {
        resultElement.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-times-circle"></i> ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}
            </div>
        `;
    });
}
</script>
{% endblock %}