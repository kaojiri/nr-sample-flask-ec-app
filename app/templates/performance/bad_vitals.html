{% extends "base.html" %}

{% block title %}Core Web Vitals ãŒæ‚ªã„ãƒšãƒ¼ã‚¸ - EC Shop{% endblock %}

{% block content %}
<div class="alert alert-info">
    <strong>ğŸ“Š ã“ã®ãƒšãƒ¼ã‚¸ã¯ Core Web Vitals ãŒæ‚ªããªã‚‹ã‚ˆã†ã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™</strong>
</div>

<h1>å•†å“ä¸€è¦§ï¼ˆCore Web Vitals ãƒ‡ãƒ¢ï¼‰</h1>

<!-- LCP ã‚’æ‚ªåŒ–ã•ã›ã‚‹: å·¨å¤§ãªç”»åƒ -->
<div class="mb-4">
    <img src="https://picsum.photos/1920/1080?random=1"
         alt="Large Hero Image"
         class="img-fluid"
         style="width: 100%; height: auto;">
</div>

<!-- CLS ã‚’æ‚ªåŒ–ã•ã›ã‚‹: ã‚µã‚¤ã‚ºæœªæŒ‡å®šã®ç”»åƒ -->
<div id="dynamic-content"></div>

<div class="row">
    {% for product in products %}
    <div class="col-md-3 mb-4">
        <div class="card">
            <!-- CLS ã‚’æ‚ªåŒ–: ã‚µã‚¤ã‚ºæœªæŒ‡å®š -->
            <img src="https://picsum.photos/300/300?random={{ loop.index }}"
                 class="card-img-top"
                 alt="{{ product.name }}">
            <div class="card-body">
                <h5 class="card-title">{{ product.name }}</h5>
                <p class="card-text">Â¥{{ product.price }}</p>
                <!-- INP ã‚’æ‚ªåŒ–ã•ã›ã‚‹ãƒœã‚¿ãƒ³ -->
                <button class="btn btn-primary btn-sm" onclick="heavyComputation({{ loop.index }})">
                    è©³ç´°ã‚’è¦‹ã‚‹
                </button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°CSS -->
<style>
    /* å¤§é‡ã®CSSãƒ«ãƒ¼ãƒ«ã§LCPã‚’é…å»¶ */
    {% for i in range(1000) %}
    .dummy-class-{{ i }} {
        background-color: #{{ '%06x' % (i * 100) }};
        margin: {{ i }}px;
        padding: {{ i }}px;
    }
    {% endfor %}
</style>

<script>
// INP ã‚’æ‚ªåŒ–ã•ã›ã‚‹: é‡ã„å‡¦ç†
function heavyComputation(productId) {
    // 500msä»¥ä¸Šã‹ã‹ã‚‹å‡¦ç†
    let result = 0;
    for (let i = 0; i < 10000000; i++) {
        result += Math.sqrt(i);
    }

    // ã•ã‚‰ã«DOMæ“ä½œã§é…å»¶
    const start = Date.now();
    while (Date.now() - start < 200) {
        // Busy wait
    }

    alert('å•†å“ ' + productId + ' ã®è©³ç´°ï¼ˆè¨ˆç®—çµæœ: ' + result + 'ï¼‰');
}

// CLS ã‚’æ‚ªåŒ–ã•ã›ã‚‹: é…å»¶ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®æŒ¿å…¥
window.addEventListener('load', function() {
    setTimeout(function() {
        const dynamicContent = document.getElementById('dynamic-content');
        const banner = document.createElement('div');
        banner.className = 'alert alert-warning';
        banner.style.height = '200px';
        banner.innerHTML = '<h3>é…å»¶è¡¨ç¤ºã•ã‚ŒãŸåºƒå‘ŠãƒãƒŠãƒ¼</h3><p>ã“ã‚Œã¯CLSã‚’æ‚ªåŒ–ã•ã›ã¾ã™</p>';
        dynamicContent.appendChild(banner);
    }, 2000);

    // ã•ã‚‰ã«åˆ¥ã®é…å»¶ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
    setTimeout(function() {
        const banner2 = document.createElement('div');
        banner2.className = 'alert alert-info';
        banner2.style.height = '150px';
        banner2.innerHTML = '<h4>ã•ã‚‰ã«é…å»¶ã—ãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„</h4>';
        document.querySelector('.row').insertAdjacentElement('beforebegin', banner2);
    }, 3000);
});

// LCP ã‚’æ‚ªåŒ–ã•ã›ã‚‹: å¤§é‡ã®ç”»åƒã‚’é…å»¶ãƒ­ãƒ¼ãƒ‰
setTimeout(function() {
    const cards = document.querySelectorAll('.card-img-top');
    cards.forEach(function(img, index) {
        // æ—¢ã«èª­ã¿è¾¼ã¾ã‚ŒãŸç”»åƒã‚’å†èª­ã¿è¾¼ã¿
        setTimeout(function() {
            img.src = img.src + '&reload=' + Date.now();
        }, index * 100);
    });
}, 1000);
</script>

<div class="mt-4">
    <a href="{{ url_for('performance.index') }}" class="btn btn-outline-primary">â† ãƒ‡ãƒ¢ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
</div>

<div class="alert alert-info mt-4">
    <h5>ğŸ” New Relic Browser ã§ç¢ºèªã™ã¹ãç‚¹:</h5>
    <ul>
        <li><strong>LCP (Largest Contentful Paint)</strong>: 4ç§’ä»¥ä¸Š</li>
        <li><strong>INP (Interaction to Next Paint)</strong>: 500msä»¥ä¸Š</li>
        <li><strong>CLS (Cumulative Layout Shift)</strong>: 0.25ä»¥ä¸Š</li>
        <li><strong>Session Traces</strong>: ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®è©³ç´°</li>
    </ul>
    <p class="mb-0">
        <strong>æ³¨:</strong> Core Web Vitals ã‚’æ¸¬å®šã™ã‚‹ã«ã¯ã€New Relic Browser monitoring ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
    </p>
</div>
{% endblock %}
