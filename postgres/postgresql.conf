# PostgreSQL設定ファイル
# New Relic監視のための最小限設定

# 接続設定（New Relic Infrastructure Agentからの接続を許可）
listen_addresses = '*'
port = 5432

# 共有ライブラリの設定（New Relic監視用拡張を有効にする）
shared_preload_libraries = 'pg_stat_statements,pg_wait_sampling,pg_stat_monitor'

# pg_stat_statements設定（Query Performance Monitoring用）
pg_stat_statements.max = 10000
pg_stat_statements.track = all
pg_stat_statements.track_utility = on
pg_stat_statements.track_planning = on  # プランニング時間も追跡
pg_stat_statements.save = on

# pg_wait_sampling設定（Wait Time Analysis用）
pg_wait_sampling.history_size = 5000
pg_wait_sampling.history_period = 1000  # 1秒間隔でサンプリング
pg_wait_sampling.profile_period = 10000  # 10秒間隔でプロファイル

# pg_stat_monitorは使用しない（pg_stat_statementsで十分）

# 統計情報収集の設定（New Relic監視に必要）
track_activities = on
track_counts = on
track_io_timing = on
track_functions = all

# ログ設定（Query Performance Monitoring用）
log_min_duration_statement = 1000  # 1秒以上のクエリをログに記録
log_duration = on
log_statement = 'all'

# Wait event monitoring（Wait Time Analysis用）
log_lock_waits = on
log_checkpoints = on
log_connections = on
log_disconnections = on

# Query Performance Monitoring用の詳細ログ設定
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_min_error_statement = error
log_min_messages = warning

# その他の設定はPostgreSQLのデフォルトを使用