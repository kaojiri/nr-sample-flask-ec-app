# 要件書

## 概要

既存のFlaskアプリケーションに対して、New Relic Infrastructure AgentによるPostgreSQL On-Host Integrationを追加する機能です。Database MonitoringとQuery Performance Monitoringを含む包括的な監視を、既存環境を変更せずにDocker Composeの新しいインフラエージェントコンテナを通じて実現します。

## 用語集

- **New Relic Infrastructure Agent**: New Relicのインフラストラクチャ監視エージェント
- **PostgreSQL On-Host Integration**: Infrastructure Agent上で動作するPostgreSQL統合監視
- **Database Monitoring**: New RelicのPostgreSQLデータベース監視機能
- **Query Performance Monitoring**: SQLクエリのパフォーマンス監視機能
- **Docker Compose**: 複数のDockerコンテナを管理するツール
- **PostgreSQL**: 使用中のデータベースシステム（postgres:15）

## 要件

### 要件1

**ユーザーストーリー:** 開発者として、既存のアプリケーション環境を変更せずにPostgreSQLの監視を追加したい。そうすることで、安全にデータベースパフォーマンスを監視できる。

#### 受け入れ基準

1. インフラエージェントコンテナは、docker-compose.yml内で独立したサービスとして動作すること
2. インフラエージェントが起動する際、既存のアプリケーションコンテナを変更せずにPostgreSQLデータベースに接続すること
3. インフラエージェントコンテナは、PostgreSQLメトリクスを収集してNew Relicに送信すること
4. インフラエージェントコンテナは、既存のアプリケーションコードやデータベース設定の変更を必要としないこと
5. データベース認証情報が必要な場合、インフラエージェントコンテナは環境変数を通じてアクセスすること

### 要件2

**ユーザーストーリー:** 運用担当者として、PostgreSQLのOn-Host Integrationを有効にしたい。そうすることで、データベースの詳細なメトリクスを監視できる。

#### 受け入れ基準

1. インフラエージェントコンテナは、PostgreSQL On-Host Integrationを設定ファイルで有効にすること
2. PostgreSQL統合が有効な際、インフラエージェントコンテナはデータベース接続プール、アクティブ接続数を収集すること
3. インフラエージェントコンテナは、テーブル、インデックス、データベースサイズの統計情報を収集すること
4. インフラエージェントコンテナは、トランザクション、コミット、ロールバック数を収集すること
5. インフラエージェントコンテナは、すべてのPostgreSQLメトリクスをNew Relic Infrastructureに送信すること

### 要件3

**ユーザーストーリー:** データベース管理者として、Query Performance Monitoringを有効にしたい。そうすることで、遅いクエリやパフォーマンスの問題を特定できる。

#### 受け入れ基準

1. インフラエージェントコンテナは、PostgreSQLのQuery Performance Monitoringを設定で有効にすること
2. Query Performance Monitoringが有効な際、インフラエージェントコンテナはpg_stat_statementsからクエリ統計を収集すること
3. インフラエージェントコンテナは、クエリ実行時間、実行回数、平均実行時間を収集すること
4. インフラエージェントコンテナは、最も時間のかかるクエリとリソース消費の多いクエリを特定すること
5. インフラエージェントコンテナは、クエリパフォーマンスデータをNew Relic Database Monitoringに送信すること

### 要件4

**ユーザーストーリー:** システム管理者として、監視設定を環境変数で管理したい。そうすることで、異なる環境間で設定を柔軟に変更できる。

#### 受け入れ基準

1. インフラエージェントコンテナは、環境変数からNew Relicライセンスキーを読み取ること
2. インフラエージェントコンテナは、環境変数からPostgreSQL接続詳細を読み取ること
3. インフラエージェントコンテナは、環境変数による設定オーバーライドをサポートすること
4. 環境変数が不足している場合、インフラエージェントコンテナは明確なエラーメッセージを提供すること
5. インフラエージェントコンテナは、監視を開始する前にすべての必要な設定を検証すること