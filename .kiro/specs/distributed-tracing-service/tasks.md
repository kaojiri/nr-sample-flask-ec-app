# Implementation Plan

- [x] 1. 分散サービスの基本構造とDocker設定を作成する
  - 分散サービス用のディレクトリ構造を作成する
  - Dockerfileを作成してPython Flask環境を構築する
  - docker-compose.ymlに分散サービスを追加する
  - 基本的なFlaskアプリケーションを作成する
  - _Requirements: 1.1, 1.2, 1.3_

- [x] 2. New Relic統合とCustom Attribute機能を実装する
  - 分散サービス用のnewrelic.ini設定ファイルを作成する
  - New RelicエージェントをFlaskアプリケーションに統合する
  - userIdをCustom Attributeとして設定するユーティリティ関数を実装する
  - 分散トレーシングヘッダーの処理機能を実装する
  - _Requirements: 2.1, 2.2, 2.3, 2.4_

- [x] 3. データベース接続とモデルを設定する
  - SQLAlchemyデータベース接続を設定する
  - 既存のUser, Product, Order, OrderItemモデルを分散サービスに複製する
  - データベース初期化とマイグレーション機能を実装する
  - _Requirements: 4.1, 4.2_

- [x] 4. パフォーマンス問題のあるエンドポイントを実装する
- [x] 4.1 N+1クエリ問題のエンドポイントを実装する
  - N+1クエリを発生させるエンドポイントを作成する
  - userIdをCustom Attributeとして設定する
  - クエリ実行回数とレスポンス時間をログ出力する
  - _Requirements: 5.1, 5.4_

- [x] 4.2 スロークエリのエンドポイントを実装する
  - pg_sleepを使った意図的な遅延クエリを実装する
  - 複雑なJOINとCartesian Productクエリを実装する
  - userIdをCustom Attributeとして設定する
  - _Requirements: 5.2, 5.4_

- [x] 4.3 データベースエラーのエンドポイントを実装する
  - 意図的なSQLエラーを発生させるエンドポイントを作成する
  - エラー時のCustom Attribute設定を実装する
  - New Relicへのエラー報告機能を実装する
  - _Requirements: 5.3, 5.4_

- [x] 5. メインアプリケーションからの分散サービス呼び出し機能を実装する
- [x] 5.1 HTTPクライアントサービスを実装する
  - 分散サービスへのHTTP呼び出し機能を作成する
  - New Relic分散トレーシングヘッダーの送信機能を実装する
  - レスポンス処理とエラーハンドリングを実装する
  - _Requirements: 3.1, 3.2, 3.3_

- [x] 5.2 メインアプリケーションに分散呼び出しルートを追加する
  - ユーザー認証とuserIdの取得機能を実装する
  - 分散サービスへのプロキシエンドポイントを作成する
  - userIdをCustom Attributeとして設定する
  - _Requirements: 3.1, 3.4_

- [x] 5.3 分散トレーシングデモ用のWebUIを作成する
  - 分散サービス機能を呼び出すためのデモページを作成する
  - N+1クエリ、スロークエリ、エラー発生の各機能をボタンで実行できるUIを実装する
  - 実行結果とレスポンス時間を表示する機能を実装する
  - 既存のperformanceデモページと同様のスタイルでUIを作成する
  - _Requirements: 3.1, 3.4_

- [x] 6. エラーハンドリングとログ機能を実装する
  - データベース接続エラーの処理を実装する
  - HTTP通信エラーのハンドリングを実装する
  - 構造化ログ出力機能を実装する
  - New Relicエラー報告機能を統合する
  - _Requirements: 4.3, 4.4_

- [x] 7. 分散トレーシングの動作確認とテストを実行する
- [x] 7.1 基本的な分散トレーシング機能をテストする
  - メインアプリケーションから分散サービスへの呼び出しをテストする
  - New Relicでの分散トレーシング表示を確認する
  - userIdのCustom Attributeが正しく表示されることを確認する
  - _Requirements: 3.4, 2.3_

- [x] 7.2 パフォーマンス問題の監視機能をテストする
  - N+1クエリ問題がNew Relicで検出されることを確認する
  - スロークエリがNew Relicで監視されることを確認する
  - エラー発生時の追跡機能を確認する
  - _Requirements: 5.5, 4.4_

- [x] 7.3 統合テストを作成する
  - 分散サービス呼び出しの統合テストを作成する
  - New Relic監視データの検証テストを作成する
  - エラーハンドリングのテストを作成する
  - _Requirements: 3.1, 3.2, 3.3, 3.4_